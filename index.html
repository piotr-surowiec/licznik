<!doctype html>
<html lang="pl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Licznik">
  <title>≈öledzenie Czasu Pracy - Produkcja</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px;
    }

    .screen {
      display: none;
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .screen.active {
      display: block;
    }

    h1 {
      color: #f5f5f5;
      margin-bottom: 30px;
      font-size: 28px;
      text-align: center;
    }

    h2 {
      color: #34495e;
      margin: 25px 0 15px 0;
      font-size: 22px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }

    input[type='text'],
    input[type='time'],
    input[type='number'],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input[type='text']:focus,
    input[type='time']:focus,
    input[type='number']:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #3498db;
    }

    .required {
      color: #e74c3c;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin: 25px 0;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #2980b9;
    }

    .btn-success {
      background: #27ae60;
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #229954;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #c0392b;
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover:not(:disabled) {
      background: #e67e22;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #7f8c8d;
    }

    .timer-container {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: #ecf0f1;
      border-radius: 8px;
    }

    .timer {
      font-size: 48px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      margin: 10px 0;
    }

    .timer.work {
      color: #27ae60;
    }

    .timer.break {
      color: #e74c3c;
    }

    .timer-label {
      font-size: 18px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(2px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #2c3e50;
    }

    .validation-message {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }

    .validation-message.show {
      display: block;
    }

    .table-container {
      margin: 25px 0;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #34495e;
      color: white;
      font-weight: 600;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .empty-table {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }

    .stat-card {
      background: #ecf0f1;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #3498db;
    }

    .stat-label {
      color: #7f8c8d;
      margin-top: 5px;
    }

    .screen-header {
      background: #34495e;
      color: white;
      padding: 10px;
      margin: -15px -15px 15px -15px;
      border-radius: 12px 12px 0 0;
    }

    .user-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 5px;
      margin-bottom: 10px;
      padding: 8px;
      background: #ecf0f1;
      border-radius: 8px;
    }

    .info-item {
      font-size: 14px;
    }

    .info-label {
      font-weight: bold;
      color: #2c3e50;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 767px) {
      .container {
        padding: 10px;
      }

      .screen {
        padding: 20px;
      }

      .timer {
        font-size: 36px;
      }

      .button-group {
        flex-direction: column;
        width: 100%;
      }

      button {
        width: 100%;
        margin-bottom: 10px;
      }
    }

    /* Tablet Styles (iPad Portrait to Landscape) */
    @media (min-width: 768px) and (max-width: 1024px) {
      .container {
        max-width: 95%;
        padding: 20px;
      }

      .screen {
        padding: 20px;
        margin-bottom: 15px;
      }

      /* Typography enhancements for readability */
      body {
        font-size: 16px;
        /* Ensure base size is readable */
      }

      h1 {
        font-size: 32px;
      }

      h2 {
        font-size: 24px;
        padding-bottom: 12px;
      }

      /* Touch targets optimization */
      input[type='text'],
      input[type='time'],
      input[type='number'],
      input[type='date'],
      select,
      textarea,
      button {
        min-height: 48px;
        /* Minimum touch target size */
        font-size: 16px;
        /* Prevent zoom on focus on iOS */
      }

      /* Button group layout */
      .button-group {
        gap: 15px;
        justify-content: space-between;
      }

      button {
        padding: 14px 20px;
        font-size: 17px;
        flex: 1;
        /* Distribute space evenly */
        min-width: 140px;
      }

      /* Timer visibility */
      .timer {
        font-size: 64px;
        /* Larger timer for visibility */
      }

      /* Grid adjustments */
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        /* 2 columns on tablet */
        gap: 20px;
      }

      .user-info {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }

      /* Table optimization */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        /* Smooth scrolling on iOS */
      }

      th,
      td {
        padding: 14px;
        /* More breathing room in tables */
        font-size: 15px;
      }
    }

    #productSearch {
      font-size: 16px;
    }

    #productSelect {
      width: 100%;
      border: 2px solid #3498db;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }

    #productSelect option {
      padding: 8px;
    }

    #productSelect option:hover {
      background-color: #3498db;
      color: white;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- EKRAN 1: Formularz startowy -->
    <div id="screen1" class="screen active">
      <div class="screen-header">
        <h1>üìä ≈öledzenie Czasu Pracy</h1>
        <h2 style="border:none; text-align:center; margin:0; color:white; font-size:18px;">
          Produkcja - Etykietowanie - Rejestracja czasu i przerw
        </h2>
      </div>

      <h2>üë§ Dane Pracownika</h2>

      <div class="form-group">
        <label for="workerName">Imiƒô i nazwisko <span class="required">*</span></label>
        <input type="text" id="workerName" required>
      </div>

      <div class="form-group">
        <label for="machine">Maszyna/Stanowisko <span class="required">*</span></label>
        <select id="machine" required>
          <option value="">-- Wybierz maszynƒô --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="peopleCount">Ilo≈õƒá os√≥b na stanowisku <span class="required">*</span></label>
        <select id="peopleCount" required>
          <option value="">-- Wybierz ilo≈õƒá --</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </div>

      <div class="form-group">
        <label for="startTime">Godzina rozpoczƒôcia <span class="required">*</span></label>
        <input type="time" id="startTime" required>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="startWorkDay()">Rozpocznij dzie≈Ñ pracy</button>
      </div>
    </div>

    <!-- EKRAN 2: Timer i rejestracja -->
    <div id="screen2" class="screen">
      <div class="screen-header">
        <h1>‚è±Ô∏è Etykietowanie</h1>
      </div>

      <div class="user-info">
        <div class="info-item"><span class="info-label">Pracownik:</span> <span id="displayWorkerName"></span></div>
        <div class="info-item"><span class="info-label">Maszyna:</span> <span id="displayMachine"></span></div>
        <div class="info-item">
          <span class="info-label">Ilo≈õƒá os√≥b:</span> <span id="displayPeopleCount"></span>
          <button class="btn-primary" style="margin-left: 10px; padding: 6px 12px; min-width: auto; font-size: 14px;"
            onclick="openChangePeopleModal()">
            Zmie≈Ñ
          </button>
        </div>
        <div class="info-item">
          <span class="info-label">Bie≈ºƒÖcy produkt:</span> <span id="displayCurrentProduct">‚Äî</span>
        </div>
        <div class="info-item">
          <span class="info-label">Razem zaetykietowano:</span> <span id="totalLabeledDisplay">0 szt.</span>
        </div>
      </div>


      <div class="form-group">
        <label for="productSelect">Produkt do etykietowania <span class="required">*</span></label>
        <input type="text" id="productSearch" placeholder="üîç Wpisz aby wyszukaƒá produkt ..." oninput="filterProducts()"
          onfocus="showProductDropdown()" autocomplete="off" style="margin-bottom: 5px;">
        <select id="productSelect" onchange="handleProductSelect()" size="10"
          style="display: none; max-height: 400px; overflow-y: auto;">
          <option value="">-- Wybierz produkt --</option>
        </select>
      </div>

      <div id="workTimerContainer" class="timer-container">
        <div class="timer-label">‚è±Ô∏è CZAS PRACY - Etykietowanie</div>
        <div id="workTimer" class="timer work timer-display">00:00:00</div>
      </div>

      <div class="button-group">
        <button id="startBtn" class="btn-success" onclick="startLabeling()" disabled>Start</button>
        <button id="breakBtn" class="btn-warning" onclick="startBreak()" disabled>Przerwa</button>
        <button id="stopBtn" class="btn-danger" onclick="stopLabeling()" disabled>Stop</button>
      </div>

      <div id="breakTimerContainer" class="timer-container hidden">
        <div class="timer-label">‚è∏Ô∏è CZAS PRZERWANIA PRACY</div>
        <div id="breakTimer" class="timer break timer-display">00:00:00</div>
        <button id="resumeBtn" class="btn-primary" onclick="resumeWork()">Wzn√≥w pracƒô</button>
      </div>

      <!-- NOWA TABELA: Bie≈ºƒÖce przerwy w tej sesji -->
      <div id="currentBreaksContainer" class="hidden" style="margin-bottom: 20px;">
        <h3>Bie≈ºƒÖce przerwy w tej sesji:</h3>
        <div class="table-container">
          <table id="currentBreaksTable">
            <thead>
              <tr>
                <th>Lp.</th>
                <th>Start</th>
                <th>Stop</th>
                <th>Czas (min)</th>
                <th>Przyczyna</th>
              </tr>
            </thead>
            <tbody id="currentBreaksBody">
              <!-- Wiersze generowane przez JS -->
            </tbody>
          </table>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        <div class="form-group" style="margin-bottom: 0;">
          <label for="quantityInput">Ilo≈õƒá zaetykietowana:<span class="required">*</span></label>
          <input type="number" id="quantityInput" min="1" placeholder="Wpisz ilo≈õƒá">
          <div id="quantityValidation" class="validation-message">Wymagane!</div>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label for="labelTypeSelect">Rodzaj etykiety:<span class="required">*</span></label>
          <select id="labelTypeSelect">
            <option value="">-- Wybierz rodzaj --</option>
          </select>
          <div id="labelTypeValidation" class="validation-message">Wybierz!</div>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label for="batchNumberInput">Data i nr partii:<span class="required">*</span></label>
          <input type="text" id="batchNumberInput" placeholder="DD.RRRR L.MM.DD">
          <div id="batchValidation" class="validation-message">Wymagane!</div>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        <div class="form-group" style="margin-bottom: 0;">
          <label for="productionDateInput">Data produkcji:<span class="required">*</span></label>
          <input type="date" id="productionDateInput">
          <div id="prodDateValidation" class="validation-message">Wybierz datƒô!</div>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label for="cardNumberInput">Nr kart FO-18:<span class="required">*</span></label>
          <input type="text" id="cardNumberInput" placeholder="X/XX/XX/RRRR">
          <div id="cardValidation" class="validation-message">Wymagane!</div>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label>Rodzaj Pakowania <span class="required">*</span></label>
          <div style="display: flex; gap: 20px; margin-top: 10px;">
            <label style="font-weight: normal; cursor: pointer;">
              <input type="radio" name="packagingType" value="Folia" onchange="saveState()" checked> Folia
            </label>
            <label style="font-weight: normal; cursor: pointer;">
              <input type="radio" name="packagingType" value="Karton" onchange="saveState()"> Karton
            </label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="notesInput">Uwagi (opcjonalne)</label>
        <textarea id="notesInput" rows="2" placeholder="Opcjonalne uwagi"></textarea>
      </div>

      <div id="breakModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">‚è∏Ô∏è Przyczyna przerwania pracy</div>

          <div class="form-group">
            <label for="breakReason">Wybierz przyczynƒô przerwy<span class="required">*</span></label>
            <select id="breakReason" onchange="handleBreakReasonChange()">
              <option value="">-- Wybierz --</option>
              <option value="Awaria">Awaria</option>
              <option value="Przerwa ≈õniadaniowa">Przerwa ≈õniadaniowa</option>
            </select>
          </div>

          <div class="form-group hidden" id="descriptionRequired">
            <label for="breakDescription">Opis awarii<span class="required">*</span></label>
            <textarea id="breakDescription" rows="3" placeholder="Opisz przyczynƒô przerwy"></textarea>
            <div id="breakValidation" class="validation-message">Opis awarii jest wymagany!</div>
          </div>

          <div class="button-group">
            <button class="btn-secondary" onclick="cancelBreak()">Anuluj</button>
            <button class="btn-primary" onclick="confirmBreak()">Potwierd≈∫</button>
          </div>
        </div>
      </div>

      <!-- Modal zmiany ilo≈õci os√≥b -->
      <div id="changePeopleModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">üë• Zmiana ilo≈õci os√≥b na stanowisku</div>
          <div class="form-group">
            <label for="newPeopleCount">Nowa ilo≈õƒá os√≥b <span class="required">*</span></label>
            <label for="newPeopleCount">Nowa ilo≈õƒá os√≥b <span class="required">*</span></label>
            <select id="newPeopleCount">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
          </div>
          <div class="button-group">
            <button class="btn-secondary" onclick="cancelChangePeople()">Anuluj</button>
            <button class="btn-primary" onclick="confirmChangePeople()">OK</button>
          </div>
        </div>
      </div>

      <h2>Historia etykietowania - sesje pracy:</h2>
      <div class="table-container">
        <table id="labelingHistoryTable">
          <thead>
            <tr>
              <th>Lp.</th>
              <th>Produkt</th>
              <th>Data i nr partii</th>
              <th>Data produkcji</th>
              <th>Nr kart FO-18</th>
              <th>Rodzaj etykiety</th>
              <th>Pakowanie</th>
              <th>Start</th>
              <th>Stop</th>
              <th>Czas (min)</th>
              <th>Sztuki</th>
              <th>Uwagi</th>
              <th>Przerwa (min)</th>
              <th>Norma</th>
            </tr>
          </thead>
          <tbody id="labelingHistoryBody">
            <tr class="empty-table">
              <td colspan="12">Brak sesji</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Historia przerw:</h2>
      <div class="table-container">
        <table id="breakHistoryTable">
          <thead>
            <tr>
              <th>Lp.</th>
              <th>Lp. sesji pracy</th>
              <th>Start</th>
              <th>Stop</th>
              <th>Czas (min)</th>
              <th>Przyczyna</th>
              <th>Produkt</th>
            </tr>
          </thead>
          <tbody id="breakHistoryBody">
            <tr class="empty-table">
              <td colspan="7">Brak przerw</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Historia zmian ilo≈õci os√≥b:</h2>
      <div class="table-container">
        <table id="peopleChangeHistoryTable">
          <thead>
            <tr>
              <th>Lp.</th>
              <th>Poprzednia ilo≈õƒá</th>
              <th>Nowa ilo≈õƒá</th>
              <th>Data i godzina zmiany</th>
            </tr>
          </thead>
          <tbody id="peopleChangeHistoryBody">
            <tr class="empty-table">
              <td colspan="4">Brak zmian</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="button-group">
        <button class="btn-secondary" onclick="confirmEndDay()">Zako≈Ñcz dzie≈Ñ pracy</button>
      </div>
    </div>

    <!-- EKRAN 3: Podsumowanie -->
    <div id="screen3" class="screen">
      <div class="screen-header">
        <h1>üìã Podsumowanie Dnia Pracy</h1>
      </div>

      <div class="user-info">
        <div class="info-item"><span class="info-label">Pracownik:</span> <span id="summaryWorkerName"></span></div>
        <div class="info-item"><span class="info-label">Maszyna:</span> <span id="summaryMachine"></span></div>
        <div class="info-item"><span class="info-label">Ilo≈õƒá os√≥b:</span> <span id="summaryPeopleCount"></span></div>
        <div class="info-item">
          <span class="info-label">Godziny pracy:</span> <span id="summaryWorkHours"></span>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalSessions">0</div>
          <div class="stat-label">Sesji etykietowania</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalPieces">0</div>
          <div class="stat-label">Zaetykietowano sztuk</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalWorkMinutes">0</div>
          <div class="stat-label">Minut pracy</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalBreakMinutes">0</div>
          <div class="stat-label">Minut przerw</div>
        </div>
      </div>
      <h2>Historia etykietowania:</h2>
      <div class="table-container">
        <table id="summaryLabelingTable">
          <thead>
            <tr>
              <th>Lp.</th>
              <th>Produkt</th>
              <th>Data i nr partii</th>
              <th>Data produkcji</th>
              <th>Nr kart FO-18</th>
              <th>Rodzaj etykiety</th>
              <th>Start</th>
              <th>Stop</th>
              <th>Czas</th>
              <th>Sztuki</th>
              <th>Uwagi</th>
              <th>Przerwa</th>
              <th>Norma</th>
            </tr>
          </thead>
          <tbody id="summaryLabelingBody"></tbody>
        </table>
      </div>
      <h2>Historia przerw:</h2>
      <div class="table-container">
        <table id="summaryBreakHistoryTable">
          <thead>
            <tr>
              <th>Lp.</th>
              <th>Produkt</th>
              <th>Sesja nr</th>
              <th>Rodzaj przerwy</th>
              <th>Start</th>
              <th>Stop</th>
              <th>Czas (min)</th>
              <th>Opis</th>
            </tr>
          </thead>
          <tbody id="summaryBreakHistoryBody">
            <tr class="empty-table">
              <td colspan="8">Brak przerw</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Historia zmian ilo≈õci os√≥b:</h2>
      <div class="table-container">
        <table id="summaryPeopleChangeTable">
          <thead>
            <tr>
              <th>Lp.</th>
              <th>Poprzednia ilo≈õƒá</th>
              <th>Nowa ilo≈õƒá</th>
              <th>Data i godzina zmiany</th>
            </tr>
          </thead>
          <tbody id="summaryPeopleChangeBody">
            <tr class="empty-table">
              <td colspan="4">Brak zmian</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="button-group">
        <button class="btn-secondary" onclick="backToTimer()">‚Üê Wr√≥ƒá do timera</button>
        <button class="btn-primary" onclick="sendToGoogleSheets()">Wy≈õlij do Google Sheet ‚úì</button>
        <button class="btn-success" onclick="confirmStartNewDay()">Rozpocznij nowy dzie≈Ñ</button>
      </div>
    </div>
  </div>
  <script>
    const STATE_KEY = 'trackingAppStateV2';
    // Globalny stan
    let currentScreen = 1;
    let workerName = '';
    let machine = '';
    let peopleCount = '';
    let plannedStartTime = '';
    let plannedEndTime = '';
    // Bie≈ºƒÖca sesja
    let currentProduct = '';
    let workStartAt = null;
    let workTimerInterval = null;
    let isOnBreak = false;
    let breakStartAt = null;
    let breakTimerInterval = null;
    let totalBreakSeconds = 0;
    let breaksCurrent = [];
    let packagingType = 'Folia'; // Default
    // Wszystkie sesje
    let sessions = [];
    let peopleCountHistory = [];
    // Elementy DOM
    const el = {
      screen1: document.getElementById('screen1'),
      screen2: document.getElementById('screen2'),
      screen3: document.getElementById('screen3'),
      workerName: document.getElementById('workerName'),
      machine: document.getElementById('machine'),
      peopleCount: document.getElementById('peopleCount'),
      startTime: document.getElementById('startTime'),
      displayWorkerName: document.getElementById('displayWorkerName'),
      displayMachine: document.getElementById('displayMachine'),
      displayPeopleCount: document.getElementById('displayPeopleCount'),
      displayCurrentProduct: document.getElementById('displayCurrentProduct'),
      totalLabeledDisplay: document.getElementById('totalLabeledDisplay'),
      productSelect: document.getElementById('productSelect'),
      workTimer: document.getElementById('workTimer'),
      workTimerContainer: document.getElementById('workTimerContainer'),
      breakTimer: document.getElementById('breakTimer'),
      breakTimerContainer: document.getElementById('breakTimerContainer'),
      startBtn: document.getElementById('startBtn'),
      breakBtn: document.getElementById('breakBtn'),
      stopBtn: document.getElementById('stopBtn'),
      resumeBtn: document.getElementById('resumeBtn'),
      quantityInput: document.getElementById('quantityInput'),
      quantityValidation: document.getElementById('quantityValidation'),
      breakModal: document.getElementById('breakModal'),
      breakReason: document.getElementById('breakReason'),
      breakDescription: document.getElementById('breakDescription'),
      descriptionRequired: document.getElementById('descriptionRequired'),
      breakValidation: document.getElementById('breakValidation'),
      labelingHistoryBody: document.getElementById('labelingHistoryBody'),
      breakHistoryBody: document.getElementById('breakHistoryBody'),
      summaryWorkerName: document.getElementById('summaryWorkerName'),
      summaryMachine: document.getElementById('summaryMachine'),
      summaryPeopleCount: document.getElementById('summaryPeopleCount'),
      summaryWorkHours: document.getElementById('summaryWorkHours'),
      totalSessions: document.getElementById('totalSessions'),
      totalPieces: document.getElementById('totalPieces'),
      totalWorkMinutes: document.getElementById('totalWorkMinutes'),
      totalBreakMinutes: document.getElementById('totalBreakMinutes'),
      summaryLabelingBody: document.getElementById('summaryLabelingBody'),

      labelTypeSelect: document.getElementById('labelTypeSelect'),
      labelTypeValidation: document.getElementById('labelTypeValidation'),
      batchNumberInput: document.getElementById('batchNumberInput'),
      batchValidation: document.getElementById('batchValidation'),
      productionDateInput: document.getElementById('productionDateInput'),
      prodDateValidation: document.getElementById('prodDateValidation'),
      cardNumberInput: document.getElementById('cardNumberInput'),
      cardValidation: document.getElementById('cardValidation'),
      notesInput: document.getElementById('notesInput'),
      changePeopleModal: document.getElementById('changePeopleModal'),
      newPeopleCount: document.getElementById('newPeopleCount'),
      peopleChangeHistoryBody: document.getElementById('peopleChangeHistoryBody'),
      currentBreaksContainer: document.getElementById('currentBreaksContainer'),
      currentBreaksBody: document.getElementById('currentBreaksBody'),
    };
    // Narzƒôdzia
    function formatHMS(sec) {
      const h = Math.floor(sec / 3600)
        .toString()
        .padStart(2, '0');
      const m = Math.floor((sec % 3600) / 60)
        .toString()
        .padStart(2, '0');
      const s = Math.floor(sec % 60)
        .toString()
        .padStart(2, '0');
      return `${h}:${m}:${s}`;
    }
    function formatTime(date) {
      if (!date) return '';
      return new Date(date).toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
    }
    // Stan UI
    function updateButtonStates(state) {
      switch (state) {
        case 'initial':
          el.startBtn.disabled = true;
          el.breakBtn.disabled = true;
          el.stopBtn.disabled = true;
          el.resumeBtn.classList.add('hidden');
          break;
        case 'productSelected':
          el.startBtn.disabled = false;
          el.breakBtn.disabled = true;
          el.stopBtn.disabled = true;
          el.resumeBtn.classList.add('hidden');
          break;
        case 'working':
          el.startBtn.disabled = true;
          el.breakBtn.disabled = false;
          el.stopBtn.disabled = false;
          el.resumeBtn.classList.add('hidden');
          break;
        case 'breakModal':
          el.startBtn.disabled = true;
          el.breakBtn.disabled = true;
          el.stopBtn.disabled = true;
          el.resumeBtn.classList.add('hidden');
          break;
        case 'breakConfirmed':
          el.startBtn.disabled = true;
          el.breakBtn.disabled = true;
          el.stopBtn.disabled = true;
          el.resumeBtn.classList.remove('hidden');
          break;
      }
    }
    function showScreen(n) {
      document.querySelectorAll('.screen').forEach((s) => s.classList.remove('active'));
      if (n === 1) el.screen1.classList.add('active');
      if (n === 2) el.screen2.classList.add('active');
      if (n === 3) {
        el.screen3.classList.add('active');
        generateSummary();
      }
      currentScreen = n;
      saveState();
    } // Zapis/odczyt stanu
    function saveState() {
      const state = {
        screen: currentScreen,
        workerName,
        machine,
        peopleCount,
        plannedStartTime,
        plannedEndTime,
        sessions,
        peopleCountHistory,
        current: {
          product: currentProduct,
          workStartAt,
          totalBreakSeconds,
          breaksCurrent,
          isWorking: !!workStartAt,
          isOnBreak,
          breakStartAt,
          breakReason: isOnBreak ? (el.breakReason ? el.breakReason.value : '') : '',
          breakDescription: isOnBreak ? (el.breakDescription ? el.breakDescription.value : '') : '',
          quantityDraft: el.quantityInput ? el.quantityInput.value : '',
          labelTypeDraft: el.labelTypeSelect ? el.labelTypeSelect.value : '',
          batchNumberDraft: el.batchNumberInput ? el.batchNumberInput.value : '',
          productionDateDraft: el.productionDateInput ? el.productionDateInput.value : '',
          cardNumberDraft: el.cardNumberInput ? el.cardNumberInput.value : '',
          notesDraft: el.notesInput ? el.notesInput.value : '',
          packagingType: document.querySelector('input[name="packagingType"]:checked')?.value || 'Folia',
        },
      };
      try {
        localStorage.setItem(STATE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('Save state failed', e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STATE_KEY);
        if (!raw) return false;
        const state = JSON.parse(raw);
        if (!state) return false;

        currentScreen = state.screen || 1;
        workerName = state.workerName || '';
        machine = state.machine || '';
        peopleCount = state.peopleCount || '';
        plannedStartTime = state.plannedStartTime || '';
        plannedEndTime = state.plannedEndTime || '';
        sessions = Array.isArray(state.sessions) ? state.sessions : [];
        peopleCountHistory = Array.isArray(state.peopleCountHistory) ? state.peopleCountHistory : [];

        el.workerName.value = workerName;
        el.machine.value = machine;
        el.peopleCount.value = peopleCount;
        el.startTime.value = plannedStartTime;
        el.displayWorkerName.textContent = workerName;
        el.displayMachine.textContent = machine;
        el.displayPeopleCount.textContent = peopleCount;
        el.summaryWorkerName.textContent = workerName;
        el.summaryMachine.textContent = machine;
        el.summaryPeopleCount.textContent = peopleCount;
        el.summaryWorkHours.textContent =
          plannedStartTime && plannedEndTime ? `${plannedStartTime} - ${plannedEndTime}` : '';

        const cur = state.current || {};
        currentProduct = cur.product || '';
        workStartAt = cur.workStartAt || null;
        totalBreakSeconds = cur.totalBreakSeconds || 0;
        breaksCurrent = Array.isArray(cur.breaksCurrent) ? cur.breaksCurrent : [];
        isOnBreak = !!cur.isOnBreak;
        breakStartAt = cur.breakStartAt || null;
        el.productSelect.value = currentProduct || '';
        el.displayCurrentProduct.textContent = currentProduct || '‚Äî';
        if (el.quantityInput) el.quantityInput.value = cur.quantityDraft || '';
        if (el.labelTypeSelect) el.labelTypeSelect.value = cur.labelTypeDraft || '';
        if (el.batchNumberInput) el.batchNumberInput.value = cur.batchNumberDraft || '';
        if (el.productionDateInput) el.productionDateInput.value = cur.productionDateDraft || '';
        if (el.cardNumberInput) el.cardNumberInput.value = cur.cardNumberDraft || '';
        if (el.notesInput) el.notesInput.value = cur.notesDraft || '';

        if (cur.packagingType) {
          const radio = document.querySelector(`input[name="packagingType"][value="${cur.packagingType}"]`);
          if (radio) radio.checked = true;
          packagingType = cur.packagingType;
        }

        updateLabelingHistoryTable();
        updateBreakHistoryTable();
        updatePeopleChangeHistoryTable();
        updateTotalLabeled();
        updateCurrentBreaksTable(); // Added this

        if (workStartAt) {
          if (isOnBreak) {
            el.breakTimerContainer.classList.remove('hidden');
            el.workTimerContainer.classList.add('hidden');
            el.breakReason.value = cur.breakReason || '';
            el.breakDescription.value = cur.breakDescription || '';
            startWorkInterval();
            startBreakInterval();
            updateButtonStates('breakConfirmed');
          } else {
            el.breakTimerContainer.classList.add('hidden');
            el.workTimerContainer.classList.remove('hidden');
            startWorkInterval();
            updateButtonStates('working');
          }
        } else {
          if (currentProduct) updateButtonStates('productSelected');
          else updateButtonStates('initial');
        }

        showScreen(currentScreen);
        return true;
      } catch (e) {
        console.warn('Load state failed', e);
        return false;
      }
    }

    // Start/pauza pracy
    function startWorkDay() {
      workerName = el.workerName.value.trim();
      machine = el.machine.value;
      peopleCount = el.peopleCount.value;
      plannedStartTime = el.startTime.value;
      if (!workerName || !machine || !peopleCount || !plannedStartTime) {
        alert('Wszystkie pola sƒÖ wymagane!');
        return;
      }
      el.displayWorkerName.textContent = workerName;
      el.displayMachine.textContent = machine;
      el.displayPeopleCount.textContent = peopleCount;
      el.summaryWorkerName.textContent = workerName;
      el.summaryMachine.textContent = machine;
      el.summaryPeopleCount.textContent = peopleCount;
      el.summaryWorkHours.textContent = `${plannedStartTime} - (w trakcie)`;
      showScreen(2);
      resetSession(false);
      saveState();
    }
    function handleProductSelect() {
      currentProduct = el.productSelect.value;

      // Wype≈Çnij pole wyszukiwania wybranym produktem
      const searchInput = document.getElementById('productSearch');
      if (searchInput && currentProduct) {
        searchInput.value = currentProduct;
      }

      // Ukryj listƒô
      const productSelect = document.getElementById('productSelect');
      if (productSelect) {
        productSelect.style.display = 'none';
      }

      el.displayCurrentProduct.textContent = currentProduct;
      if (currentProduct) {
        updateButtonStates('productSelected');
      } else {
        updateButtonStates('initial');
      }
      saveState();
    }

    function resetSession(clearProduct = true) {
      workStartAt = null;
      isOnBreak = false;
      breakStartAt = null;
      stopIntervals();
      totalBreakSeconds = 0;
      breaksCurrent = [];
      if (el.quantityInput) el.quantityInput.value = '';
      if (el.labelTypeSelect) el.labelTypeSelect.value = '';
      if (el.batchNumberInput) el.batchNumberInput.value = '';
      if (el.productionDateInput) el.productionDateInput.value = '';
      if (el.cardNumberInput) el.cardNumberInput.value = '';
      if (el.notesInput) el.notesInput.value = '';
      if (clearProduct) {
        currentProduct = '';
        if (el.productSelect) el.productSelect.value = '';
        if (el.displayCurrentProduct) el.displayCurrentProduct.textContent = '‚Äî';
      }
      if (el.workTimer) el.workTimer.textContent = '00:00:00';
      if (el.breakTimer) el.breakTimer.textContent = '00:00:00';
      if (el.breakTimerContainer) el.breakTimerContainer.classList.add('hidden');
      if (el.resumeBtn) el.resumeBtn.classList.add('hidden');
      updateButtonStates('initial');
      updateTotalLabeled();
      updateCurrentBreaksTable(); // Added this
      saveState();
    }

    function startLabeling() {
      if (!currentProduct) {
        alert('Wybierz produkt przed rozpoczƒôciem pracy!');
        return;
      }
      workStartAt = Date.now();
      el.workTimer.textContent = '00:00:00';
      startWorkInterval();
      updateButtonStates('working');
      saveState();
    }
    function startBreak() {
      // NATYCHMIAST rozpocznij liczenie przerwy
      isOnBreak = true;
      breakStartAt = Date.now();
      el.breakReason.value = '';
      el.breakDescription.value = '';
      el.breakValidation.classList.remove('show');
      el.breakTimer.textContent = '00:00:00';
      el.breakTimerContainer.classList.remove('hidden');
      el.workTimerContainer.classList.add('hidden');
      // Uruchom czerwony timer NATYCHMIAST
      startBreakInterval();
      updateButtonStates('breakModal');
      el.breakModal.classList.add('active');
      saveState();
    }
    function handleBreakReasonChange() {
      const reason = el.breakReason.value;
      if (reason === 'Awaria') {
        el.descriptionRequired.classList.remove('hidden');
        el.breakDescription.required = true;
      } else {
        el.descriptionRequired.classList.add('hidden');
        el.breakDescription.required = false;
      }
    }
    function cancelBreak() {
      el.breakModal.classList.remove('active');
      el.breakTimerContainer.classList.add('hidden');
      el.workTimerContainer.classList.remove('hidden');
      updateButtonStates('working');
      saveState();
    }
    function confirmBreak() {
      const reason = el.breakReason.value;
      const description = (el.breakDescription.value || '').trim();
      if (!reason) {
        alert('Wybierz przyczynƒô przerwy!');
        return;
      }
      if (reason === 'Awaria' && !description) {
        el.breakValidation.classList.add('show');
        return;
      }
      el.breakValidation.classList.remove('show');
      el.breakModal.classList.remove('active');
      el.resumeBtn.classList.remove('hidden');
      updateButtonStates('breakConfirmed');
      saveState();
    }
    function resumeWork() {
      if (!isOnBreak || !breakStartAt) return;
      const now = Date.now();
      const segSec = Math.floor((now - breakStartAt) / 1000);
      totalBreakSeconds += segSec;
      breaksCurrent.push({
        sessionNumber: sessions.length + 1,
        startTime: breakStartAt,
        endTime: now,
        duration: segSec,
        reason: el.breakReason.value,
        description: el.breakDescription.value,
        product: currentProduct,
      });
      stopBreakInterval();
      isOnBreak = false;
      breakStartAt = null;
      el.breakTimerContainer.classList.add('hidden');
      el.workTimerContainer.classList.remove('hidden');
      el.resumeBtn.classList.add('hidden');
      updateBreakHistoryTable();
      updateCurrentBreaksTable(); // Added this
      updateButtonStates('working');
      saveState();
    }
    function stopLabeling() {
      if (
        !el.quantityInput ||
        !el.labelTypeSelect ||
        !el.batchNumberInput ||
        !el.productionDateInput ||
        !el.cardNumberInput
      ) {
        alert('B≈ÇƒÖd: brak wymaganych p√≥l formularza');
        return;
      }

      const qty = parseInt(el.quantityInput.value);
      const labelType = el.labelTypeSelect.value;
      const batchNumber = el.batchNumberInput.value.trim();
      const productionDate = el.productionDateInput.value;
      const cardNumber = el.cardNumberInput.value.trim();
      const notes = el.notesInput ? el.notesInput.value.trim() : '';

      let hasError = false;

      if (!qty || qty <= 0) {
        if (el.quantityValidation) el.quantityValidation.classList.add('show');
        hasError = true;
      } else {
        if (el.quantityValidation) el.quantityValidation.classList.remove('show');
      }

      if (!labelType) {
        if (el.labelTypeValidation) el.labelTypeValidation.classList.add('show');
        hasError = true;
      } else {
        if (el.labelTypeValidation) el.labelTypeValidation.classList.remove('show');
      }

      if (!batchNumber) {
        if (el.batchValidation) el.batchValidation.classList.add('show');
        hasError = true;
      } else {
        if (el.batchValidation) el.batchValidation.classList.remove('show');
      }

      if (!productionDate) {
        if (el.prodDateValidation) el.prodDateValidation.classList.add('show');
        hasError = true;
      } else {
        if (el.prodDateValidation) el.prodDateValidation.classList.remove('show');
      }

      if (!cardNumber) {
        if (el.cardValidation) el.cardValidation.classList.add('show');
        hasError = true;
      } else {
        if (el.cardValidation) el.cardValidation.classList.remove('show');
      }

      if (hasError) {
        alert('Wype≈Çnij wszystkie wymagane pola przed zako≈Ñczeniem sesji!');
        return;
      }

      if (isOnBreak && breakStartAt) {
        const now = Date.now();
        const segSec = Math.floor((now - breakStartAt) / 1000);
        totalBreakSeconds += segSec;
        breaksCurrent.push({
          sessionNumber: sessions.length + 1,
          startTime: breakStartAt,
          endTime: now,
          duration: segSec,
          reason: el.breakReason ? el.breakReason.value : '',
          description: el.breakDescription ? el.breakDescription.value : '',
          product: currentProduct,
        });
        stopBreakInterval();
        isOnBreak = false;
        breakStartAt = null;
      }

      stopWorkInterval();
      const now = Date.now();
      const session = {
        number: sessions.length + 1,
        product: currentProduct,
        batchNumber: batchNumber,
        productionDate: productionDate,
        cardNumber: cardNumber,
        labelType: labelType,
        notes: notes,
        startTime: workStartAt,
        endTime: now,
        workDuration: Math.floor((now - workStartAt) / 1000 / 60),
        breakDuration: Math.ceil(totalBreakSeconds / 60),
        quantity: qty,
        packagingType: document.querySelector('input[name="packagingType"]:checked')?.value || 'Folia',
        peopleCount: parseInt(peopleCount) || 1,
        breaks: [...breaksCurrent],
      };

      sessions.push(session);
      updateLabelingHistoryTable();
      updateBreakHistoryTable();
      updateTotalLabeled();
      // Wyczy≈õƒá pole wyszukiwania produktu
      const productSearch = document.getElementById('productSearch');
      if (productSearch) {
        productSearch.value = '';
      }

      if (el.quantityInput) el.quantityInput.value = '';
      if (el.labelTypeSelect) el.labelTypeSelect.value = '';
      if (el.batchNumberInput) el.batchNumberInput.value = '';
      if (el.productionDateInput) el.productionDateInput.value = '';
      if (el.cardNumberInput) el.cardNumberInput.value = '';
      if (el.notesInput) el.notesInput.value = '';

      resetSession();
      saveState();
    }

    // Interwa≈Çy timer√≥w
    function startWorkInterval() {
      stopWorkInterval();
      workTimerInterval = setInterval(() => {
        if (workStartAt) {
          const sec = Math.floor((Date.now() - workStartAt) / 1000);
          el.workTimer.textContent = formatHMS(sec);
        }
      }, 1000);
      el.workTimer.textContent = '00:00:00';
    }
    function stopWorkInterval() {
      if (workTimerInterval) {
        clearInterval(workTimerInterval);
        workTimerInterval = null;
      }
    }
    function startBreakInterval() {
      stopBreakInterval();
      breakTimerInterval = setInterval(() => {
        if (breakStartAt) {
          const sec = Math.floor((Date.now() - breakStartAt) / 1000);
          el.breakTimer.textContent = formatHMS(sec);
        }
      }, 1000);
      el.breakTimer.textContent = '00:00:00';
    }
    function stopBreakInterval() {
      if (breakTimerInterval) {
        clearInterval(breakTimerInterval);
        breakTimerInterval = null;
      }
    }
    function stopIntervals() {
      stopWorkInterval();
      stopBreakInterval();
    } // Tabele i statystyki
    function updateLabelingHistoryTable() {
      const tbody = el.labelingHistoryBody;
      tbody.innerHTML = '';
      if (sessions.length === 0) {
        tbody.innerHTML = '<tr class="empty-table"><td colspan="12">Brak sesji</td></tr>';
        return;
      }
      sessions.forEach((s) => {
        const tr = document.createElement('tr');
        let prodDateFormatted = '';
        if (s.productionDate) {
          const parts = s.productionDate.split('-');
          if (parts.length === 3) {
            prodDateFormatted = `${parts[2]}.${parts[1]}.${parts[0]}`;
          }
        }

        // Format przerwy: "czas (opisy)"
        let breakDisplay = 'Nie';
        if (s.breakDuration > 0) {
          breakDisplay = `${s.breakDuration} min`;
          if (s.breaks && s.breaks.length > 0) {
            const reasons = s.breaks
              .map((b) => {
                if (b.reason === 'Awaria' && b.description) {
                  return `${b.reason}: ${b.description}`;
                }
                return b.reason;
              })
              .filter((r) => r)
              .join(', ');
            if (reasons) {
              breakDisplay += ` (${reasons})`;
            }
          }
        }

        tr.innerHTML = `
                    <td>${s.number}</td>
                    <td>${s.product}</td>
                    <td>${s.batchNumber || ''}</td>
                    <td>${prodDateFormatted}</td>
                    <td>${s.cardNumber || ''}</td>
                    <td>${s.labelType || ''}</td>
                    <td>${s.packagingType || '-'}</td>
                    <td>${formatTime(s.startTime)}</td>
                    <td>${formatTime(s.endTime)}</td>
                    <td>${s.workDuration}</td>
                    <td>${s.quantity}</td>
                    <td>${s.notes || ''}</td>
                    <td>${breakDisplay}</td>
                    <td>${getNormStatusHtml(s)}</td>
                `;
        tbody.appendChild(tr);
      });
    }
    function updateBreakHistoryTable() {
      const tbody = el.breakHistoryBody;
      tbody.innerHTML = '';
      // ZMIANA: Pokazuj TYLKO przerwy z zako≈Ñczonych sesji (sessions),
      // a nie bie≈ºƒÖce (breaksCurrent).
      const pastBreaks = sessions.flatMap((s) => s.breaks || []);
      const all = [...pastBreaks]; // Usuniƒôto ...breaksCurrent
      if (all.length === 0) {
        tbody.innerHTML = '<tr class="empty-table"><td colspan="7">Brak przerw</td></tr>';
        return;
      }
      all.forEach((b, idx) => {
        const tr = document.createElement('tr');
        // ZMIANA: Dodanie opisu do przyczyny
        let reasonDisplay = b.reason || '';
        if (b.description) {
          reasonDisplay += ` (${b.description})`;
        }

        tr.innerHTML = `<td>${idx + 1}</td>
                          <td>${b.sessionNumber}</td>
                          <td>${formatTime(b.startTime)}</td>
                          <td>${formatTime(b.endTime)}</td>
                          <td>${Math.floor((b.duration || 0) / 60)}</td>
                          <td>${reasonDisplay}</td>
                          <td>${b.product || ''}</td>`;
        tbody.appendChild(tr);
      });
    }
    function updateTotalLabeled() {
      const total = sessions.reduce((sum, s) => sum + (parseInt(s.quantity) || 0), 0);
      el.totalLabeledDisplay.textContent = `${total} szt.`;
    }
    function updateCurrentBreaksTable() {
      const tbody = el.currentBreaksBody;
      const container = el.currentBreaksContainer;

      if (!tbody || !container) return;

      tbody.innerHTML = '';

      if (breaksCurrent.length === 0) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');

      breaksCurrent.forEach((b, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx + 1}</td>
                        <td>${formatTime(b.startTime)}</td>
                        <td>${formatTime(b.endTime)}</td>
                        <td>${Math.floor((b.duration || 0) / 60)}</td>
                        <td>${b.reason || ''} ${b.description ? '(' + b.description + ')' : ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Podsumowanie
    function generateSummary() {
      const totalSessions = sessions.length;
      const totalPieces = sessions.reduce((sum, s) => sum + (s.quantity || 0), 0);
      const totalWorkMinutes = sessions.reduce((sum, s) => sum + (s.workDuration || 0), 0);
      const totalBreakMinutes = sessions.reduce((sum, s) => sum + (s.breakDuration || 0), 0);

      const now = new Date();
      plannedEndTime = now.toTimeString().slice(0, 5);

      el.totalSessions.textContent = totalSessions;
      el.totalPieces.textContent = totalPieces;
      el.totalWorkMinutes.textContent = totalWorkMinutes;
      el.totalBreakMinutes.textContent = totalBreakMinutes;
      el.summaryWorkHours.textContent = `${plannedStartTime} - ${plannedEndTime}`;

      // Tabela 1: Historia etykietowania (12 kolumn)
      const tbody = el.summaryLabelingBody;
      tbody.innerHTML = '';
      if (sessions.length === 0) {
        tbody.innerHTML = '<tr class="empty-table"><td colspan="12">Brak sesji</td></tr>';
      } else {
        sessions.forEach((s) => {
          const tr = document.createElement('tr');
          let prodDateFormatted = '';
          if (s.productionDate) {
            const parts = s.productionDate.split('-');
            if (parts.length === 3) {
              prodDateFormatted = `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
          }

          let breakDisplay = 'Nie';
          if (s.breakDuration > 0) {
            breakDisplay = `${s.breakDuration} min`;
            if (s.breaks && s.breaks.length > 0) {
              const reasons = s.breaks
                .map((b) => {
                  if (b.reason === 'Awaria' && b.description) {
                    return `${b.reason}: ${b.description}`;
                  }
                  return b.reason;
                })
                .filter((r) => r)
                .join(', ');
              if (reasons) breakDisplay += ` (${reasons})`;
            }
          }

          tr.innerHTML = `
                        <td>${s.number}</td>
                        <td>${s.product}</td>
                        <td>${s.batchNumber || ''}</td>
                        <td>${prodDateFormatted}</td>
                        <td>${s.cardNumber || ''}</td>
                        <td>${s.labelType || ''}</td>
                        <td>${s.packagingType || '-'}</td>
                        <td>${formatTime(s.startTime)}</td>
                        <td>${formatTime(s.endTime)}</td>
                        <td>${s.workDuration} min</td>
                        <td>${s.quantity}</td>
                        <td>${s.notes || ''}</td>
                        <td>${breakDisplay}</td>
                        <td>${getNormStatusHtml(s)}</td>
                    `;
          tbody.appendChild(tr);
        });
      }



      // Tabela 2: Historia przerw
      const breakTbody = document.getElementById('summaryBreakHistoryBody');
      if (breakTbody) {
        breakTbody.innerHTML = '';
        const allBreaks = sessions.flatMap((s) => s.breaks || []);
        if (allBreaks.length === 0) {
          breakTbody.innerHTML = '<tr class="empty-table"><td colspan="8">Brak przerw</td></tr>';
        } else {
          allBreaks.forEach((b, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                            <td>${idx + 1}</td>
                            <td>${b.product || ''}</td>
                            <td>${b.sessionNumber || ''}</td>
                            <td>${b.reason || ''}</td>
                            <td>${formatTime(b.startTime)}</td>
                            <td>${formatTime(b.endTime)}</td>
                            <td>${Math.floor(b.duration / 60)}</td>
                            <td>${b.description || ''}</td>
                        `;
            breakTbody.appendChild(tr);
          });
        }
      }

      // Tabela 3: Historia zmian ilo≈õci os√≥b
      const people–¢body = document.getElementById('summaryPeopleChangeBody');
      if (people–¢body) {
        people–¢body.innerHTML = '';
        if (peopleCountHistory.length === 0) {
          people–¢body.innerHTML = '<tr class="empty-table"><td colspan="4">Brak zmian</td></tr>';
        } else {
          peopleCountHistory.forEach((change, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                            <td>${idx + 1}</td>
                            <td>${change.previousCount}</td>
                            <td>${change.newCount}</td>
                            <td>${change.changeDate}</td>
                        `;
            people–¢body.appendChild(tr);
          });
        }
      }

      saveState();
    }

    // === FUNKCJE MODALU ZMIANY ILO≈öCI OS√ìB ===
    function openChangePeopleModal() {
      if (el.newPeopleCount && el.changePeopleModal) {
        el.newPeopleCount.value = peopleCount;
        el.changePeopleModal.classList.add('active');
      }
    }

    function cancelChangePeople() {
      if (el.changePeopleModal) el.changePeopleModal.classList.remove('active');
    }

    function confirmChangePeople() {
      if (!el.newPeopleCount) return;
      const newCount = el.newPeopleCount.value;
      if (!newCount || newCount < 1 || newCount > 10) {
        alert('Wpisz prawid≈ÇowƒÖ ilo≈õƒá os√≥b (1-10)');
        return;
      }
      if (newCount != peopleCount) {
        const now = new Date();
        peopleCountHistory.push({
          previousCount: peopleCount,
          newCount: newCount,
          changeTime: now.getTime(),
          changeDate: now.toLocaleString('pl-PL', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
          }),
        });
        peopleCount = newCount;
        if (el.displayPeopleCount) el.displayPeopleCount.textContent = peopleCount;
        if (el.summaryPeopleCount) el.summaryPeopleCount.textContent = peopleCount;
        updatePeopleChangeHistoryTable();
        saveState();
      }
      if (el.changePeopleModal) el.changePeopleModal.classList.remove('active');
    }

    function updatePeopleChangeHistoryTable() {
      if (!el.peopleChangeHistoryBody) return;
      const tbody = el.peopleChangeHistoryBody;
      tbody.innerHTML = '';
      if (peopleCountHistory.length === 0) {
        tbody.innerHTML = '<tr class="empty-table"><td colspan="4">Brak zmian</td></tr>';
        return;
      }
      peopleCountHistory.forEach((change, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
                    <td>${idx + 1}</td>
                    <td>${change.previousCount}</td>
                    <td>${change.newCount}</td>
                    <td>${change.changeDate}</td>
                `;
        tbody.appendChild(tr);
      });
    }

    // Nawigacja
    function confirmEndDay() {
      if (confirm('Czy na pewno chcesz zako≈Ñczyƒá dzie≈Ñ pracy?')) {
        showScreen(3);
      }
    }
    function backToTimer() {
      showScreen(2);
    }
    function confirmStartNewDay() {
      if (confirm('Czy na pewno chcesz rozpoczƒÖƒá nowy dzie≈Ñ? Wszystkie dane zostanƒÖ usuniƒôte!')) {
        try {
          localStorage.removeItem(STATE_KEY);
        } catch (e) { }
        sessions = [];
        peopleCountHistory = [];
        resetSession();
        workerName = machine = peopleCount = plannedStartTime = plannedEndTime = '';
        el.workerName.value = '';
        el.machine.value = '';
        el.peopleCount.value = '';
        el.startTime.value = '';
        updateLabelingHistoryTable();
        updateBreakHistoryTable();
        updatePeopleChangeHistoryTable();
        updateTotalLabeled();
        showScreen(1);
      }
    }

    // Placeholder integracji
    function sendToGoogleSheets() {
      alert('Integracja z Google Sheets nie jest jeszcze skonfigurowana.');
    }
    // === GOOGLE SHEETS - LISTA MASZYN (z wybranej kolumny) ===
    async function loadMachinesFromSheet() {
      // KONFIGURACJA
      const SHEET_ID = '1JTyATb7I4fMj7rywuByjGZmtMXNDP0uc010i3ZBoq0s';
      const GID = '542333307';
      const COLUMN_INDEX = 3; // 0=A, 1=B, 2=C, 3=D, 4=E...
      const SKIP_HEADER = true; // true = pomija pierwszy wiersz

      const url = `https://corsproxy.io/?${encodeURIComponent(
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`
      )}`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const text = await response.text();
        const lines = text.trim().split('\n');

        const machineSelect = document.getElementById('machine');
        machineSelect.innerHTML = '<option value="">-- Wybierz maszynƒô --</option>';

        const uniqueMachines = new Set();

        lines.forEach((line, index) => {
          // Pomi≈Ñ nag≈Ç√≥wek je≈õli SKIP_HEADER = true
          if (SKIP_HEADER && index === 0) return;

          // Parsuj CSV i wybierz kolumnƒô wed≈Çug COLUMN_INDEX
          const columns = line.split(',');
          const machineName = columns[COLUMN_INDEX]?.replace(/"/g, '').trim();

          if (machineName && machineName !== '') {
            uniqueMachines.add(machineName);
          }
        });

        uniqueMachines.forEach((machine) => {
          const option = document.createElement('option');
          option.value = machine;
          option.textContent = machine;
          machineSelect.appendChild(option);
        });

        console.log(
          `‚úÖ Za≈Çadowano ${uniqueMachines.size} maszyn z kolumny ${String.fromCharCode(65 + COLUMN_INDEX)}`
        );
      } catch (error) {
        console.error('‚ùå B≈ÇƒÖd ≈Çadowania maszyn:', error);
        document.getElementById('machine').innerHTML = '<option value="">B≈ÇƒÖd ≈Çadowania</option>';
      }
    }

    // Globalna tablica produkt√≥w dla filtrowania
    let allProducts = [];
    let productMap = {}; // Nazwa -> Rodzaj s≈Çoika
    let normsMap = {}; // Rodzaj s≈Çoika -> { ManualFolia, ManualKarton, AutoFolia, AutoKarton }

    // === NORMY I LOGIKA ===
    function getLineType(machineName) {
      if (!machineName) return 'MANUAL';
      const lower = machineName.toLowerCase();
      if (lower.includes('kapturkownica') || lower.includes('kapturkownicƒÖ')) {
        return 'AUTOMATIC';
      }
      return 'MANUAL';
    }

    function calculateNormTarget(product, packaging, machine, people) {
      if (!product || !packaging || !machine || !people) return 0;

      const jarType = productMap[product];
      if (!jarType) return 0;

      const norms = normsMap[jarType];
      if (!norms) return 0;

      const lineType = getLineType(machine);
      let baseNorm = 0;

      if (lineType === 'AUTOMATIC') {
        baseNorm = packaging === 'Folia' ? norms.AutoFolia : norms.AutoKarton;
      } else {
        baseNorm = packaging === 'Folia' ? norms.ManualFolia : norms.ManualKarton;
      }

      return baseNorm * people;
    }

    function getNormStatusHtml(session) {
      if (!session.quantity || !session.workDuration || session.workDuration <= 0) return '-';

      // Oblicz realnƒÖ wydajno≈õƒá (szt/h)
      const realSpeed = (session.quantity / session.workDuration) * 60;

      // Oblicz cel (szt/h)
      // Potrzebujemy liczby os√≥b z momentu sesji - ale w historii nie zapisujemy liczby os√≥b per sesja, 
      // tylko globalnie. Zapiszmy to!
      // FIX: Wcze≈õniej nie zapisywali≈õmy peopleCount w sesji, ale jest to potrzebne.
      // Zak≈Çadam, ≈ºe peopleCount jest sta≈Çe dla sesji (pobierane przy stopLabeling).
      // Je≈õli nie ma w sesji, we≈∫miemy bie≈ºƒÖce (fallback).

      // UWAGA: Wcze≈õniejszy kod nie zapisywa≈Ç peopleCount w obiekcie session. 
      // Dodam to dynamicznie w stopLabeling w kolejnym kroku, ale tutaj muszƒô obs≈Çu≈ºyƒá brak.
      const people = session.peopleCount || parseInt(peopleCount) || 1;

      // Maszyna te≈º powinna byƒá z sesji, ale nie jest zapisywana. U≈ºyjemy globalnej machine.
      // To jest pewne uproszczenie, ale w ramach jednej sesji maszyna siƒô nie zmienia.
      // Je≈õli u≈ºytkownik zmieni maszynƒô, to i tak resetuje dzie≈Ñ (zgodnie z logikƒÖ app).
      const machineUsed = machine;

      const targetNorm = calculateNormTarget(session.product, session.packagingType, machineUsed, people);

      if (targetNorm === 0) return '<span title="Brak normy">-</span>';

      const percent = (realSpeed / targetNorm) * 100;
      const icon = realSpeed >= targetNorm ? '‚úÖ' : '‚ùå';
      const tooltip = `Aktualne: ${Math.round(realSpeed)} szt/h / Norma: ${Math.round(targetNorm)} szt/h`;

      return `<span title="${tooltip}" style="cursor: help;">${icon}</span>`;
    }

    async function loadProductsFromSheet() {
      // KONFIGURACJA
      const SHEET_ID = '1JTyATb7I4fMj7rywuByjGZmtMXNDP0uc010i3ZBoq0s';
      const GID = '542333307';
      const SKIP_HEADER = true;

      const url = `https://corsproxy.io/?${encodeURIComponent(
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`
      )}`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const text = await response.text();
        const lines = text.trim().split('\n');

        allProducts = [];
        productMap = {};

        lines.forEach((line, index) => {
          if (SKIP_HEADER && index === 0) return;

          const columns = line.split(',');
          // CSV parsing simple split - uwaga na przecinki w cudzys≈Çowach, ale tu zak≈Çadamy prosty format
          // Lepiej u≈ºyƒá regexa do CSV je≈õli dane sƒÖ z≈Ço≈ºone, ale tu zostawiam prosto jak by≈Ço.
          const productName = columns[0]?.replace(/"/g, '').trim();
          const jarType = columns[1]?.replace(/"/g, '').trim();

          if (productName) {
            allProducts.push(productName);
            if (jarType) {
              productMap[productName] = jarType;
            }
          }
        });

        allProducts.sort();
        console.log(`‚úÖ Za≈Çadowano ${allProducts.length} produkt√≥w`);
      } catch (error) {
        console.error('‚ùå B≈ÇƒÖd ≈Çadowania produkt√≥w:', error);
      }
    }

    async function loadNormsFromSheet() {
      const SHEET_ID = '1JTyATb7I4fMj7rywuByjGZmtMXNDP0uc010i3ZBoq0s';
      const GID = '520596027'; // Nowy GID
      const SKIP_HEADER = true;

      const url = `https://corsproxy.io/?${encodeURIComponent(
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`
      )}`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const text = await response.text();
        const lines = text.trim().split('\n');

        normsMap = {};

        lines.forEach((line, index) => {
          if (SKIP_HEADER && index === 0) return;

          const cols = line.split(',');
          const jarType = cols[0]?.replace(/"/g, '').trim();

          if (jarType) {
            normsMap[jarType] = {
              ManualFolia: parseInt(cols[1]) || 0,
              ManualKarton: parseInt(cols[2]) || 0,
              AutoFolia: parseInt(cols[3]) || 0,
              AutoKarton: parseInt(cols[4]) || 0
            };
          }
        });
        console.log(`‚úÖ Za≈Çadowano normy dla ${Object.keys(normsMap).length} rodzaj√≥w s≈Çoik√≥w`);
      } catch (e) {
        console.error('‚ùå B≈ÇƒÖd ≈Çadowania norm:', e);
      }
    }

    // === WYSZUKIWARKA PRODUKT√ìW ===

    // Wype≈Çnij select produktami
    function populateProductSelect(products) {
      const productSelect = document.getElementById('productSelect');
      productSelect.innerHTML = '<option value="">-- Wybierz produkt --</option>';

      products.forEach((product) => {
        const option = document.createElement('option');
        option.value = product;
        option.textContent = product;
        productSelect.appendChild(option);
      });
    }

    // Filtruj produkty podczas pisania
    function filterProducts() {
      const searchInput = document.getElementById('productSearch');
      const productSelect = document.getElementById('productSelect');
      const searchText = searchInput.value.toLowerCase().trim();

      if (searchText.length === 0) {
        productSelect.style.display = 'none';
        return;
      }

      // Filtruj produkty
      const filtered = allProducts.filter((product) => product.toLowerCase().includes(searchText));

      // Aktualizuj listƒô
      populateProductSelect(filtered);

      // Poka≈º select
      if (filtered.length > 0) {
        productSelect.style.display = 'block';
      } else {
        productSelect.innerHTML = '<option value="">Brak wynik√≥w dla: "' + searchText + '"</option>';
        productSelect.style.display = 'block';
      }
    }

    // Poka≈º listƒô po klikniƒôciu w pole
    function showProductDropdown() {
      const productSelect = document.getElementById('productSelect');
      const searchInput = document.getElementById('productSearch');

      if (allProducts.length > 0 && searchInput.value.trim().length > 0) {
        filterProducts();
      }
    }

    // Ukryj listƒô po klikniƒôciu poza niƒÖ
    document.addEventListener('click', function (event) {
      const searchInput = document.getElementById('productSearch');
      const productSelect = document.getElementById('productSelect');

      if (event.target !== searchInput && event.target !== productSelect) {
        productSelect.style.display = 'none';
      }
    });

    // === GOOGLE SHEETS - LISTA RODZAJ√ìW ETYKIET ===
    async function loadLabelTypesFromSheet() {
      // KONFIGURACJA
      const SHEET_ID = '1JTyATb7I4fMj7rywuByjGZmtMXNDP0uc010i3ZBoq0s';
      const GID = '542333307';
      const COLUMN_INDEX = 5; // 5 = kolumna F (Rodzaj etykiety)
      const SKIP_HEADER = true;

      const url = `https://corsproxy.io/?${encodeURIComponent(
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`
      )}`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const text = await response.text();
        const lines = text.trim().split('\n');

        const labelTypeSelect = document.getElementById('labelTypeSelect');
        labelTypeSelect.innerHTML = '<option value="">-- Wybierz rodzaj --</option>';

        // U≈ºywamy Set ≈ºeby uniknƒÖƒá duplikat√≥w
        const uniqueLabelTypes = new Set();

        lines.forEach((line, index) => {
          if (SKIP_HEADER && index === 0) return;

          const columns = line.split(',');
          const labelType = columns[COLUMN_INDEX]?.replace(/"/g, '').trim();

          // Dodaj tylko niepuste warto≈õci
          if (labelType && labelType !== '' && labelType !== '-' && labelType !== 'brak') {
            uniqueLabelTypes.add(labelType);
          }
        });

        // Sortuj alfabetycznie (opcjonalnie)
        const sortedTypes = Array.from(uniqueLabelTypes).sort();

        sortedTypes.forEach((type) => {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type;
          labelTypeSelect.appendChild(option);
        });

        console.log(`‚úÖ Za≈Çadowano ${sortedTypes.length} rodzaj√≥w etykiet z kolumny E`);
      } catch (error) {
        console.error('‚ùå B≈ÇƒÖd ≈Çadowania rodzaj√≥w etykiet:', error);
        labelTypeSelect.innerHTML = '<option value="">B≈ÇƒÖd ≈Çadowania</option>';
      }
    }

    // Inicjalizacja
    document.addEventListener('DOMContentLoaded', () => {
      const loaded = loadState();
      // ≈Åaduj listy z op√≥≈∫nieniem (≈ºeby nie zablokowaƒá CORS proxy)
      loadMachinesFromSheet();

      setTimeout(() => {
        loadProductsFromSheet();
        loadNormsFromSheet();
      }, 500);

      setTimeout(() => {
        loadLabelTypesFromSheet();
      }, 1000); // 1 sekunda op√≥≈∫nienia

      if (!loaded) {
        updateLabelingHistoryTable();
        updateBreakHistoryTable();
        updateTotalLabeled();
        showScreen(1);
      }
    });
  </script>
</body>

</html>